---
/**
 * A menu displaying all entries of a certain type.
 * Used on content by entry pages to aid navigation.
 *
 * Props:
 *  - collection: the collection to display entries from.
 *  - collectionEntries (optional): OR the already loaded entries to display.
 *  - selected (optional): the current entry. Will highlight it if supplied.
 *  - style (optional): Style object to apply to the wrapper
 */
import { loadAndFormatCollection, type ProcessedEntry } from 'src/util/collection'
import { MenuLi, MenuLinkWrapper, MenuWrapper } from 'src/components/Menu.css'
import type { CollectionKey } from 'astro:content'
import { theme } from '../Theme.css'
import AllAgesIndicator from './AllAgesIndicator.astro'
import SeriesIndicator from './SeriesIndicator.astro'

interface Props {
	collection?: CollectionKey
	collectionEntries?: ProcessedEntry<CollectionKey>[]
	selected?: string
	style?: Partial<CSSStyleDeclaration>
}

const { selected, collection, collectionEntries, style } = Astro.props

// Helpers for conciseness
const isDied = (entry) => 'died' in entry.entry.data && entry.entry.data.died !== undefined
const isAllAges = (entry) => 'allAges' in entry.entry.data && entry.entry.data.allAges
const hasOrigin = (entry) => 'origin' in entry.entry.data

const getCategory = (entry) => `${hasOrigin(entry) ? entry.entry.data.origin : 'Dunedin'},${isDied(entry) ? 'dead' : 'active'},${isAllAges(entry) ? 'allages' : ''}`

const entries = collection ? await loadAndFormatCollection(collection) : collectionEntries
---

<ul class={`${MenuWrapper['vertical']} filter-container`} style={style}>
	{
		entries
			?.sort((a, b) => (a.entry.id < b.entry.id ? -1 : 1))
			?.map((entry) => (
				<li
					data-category={getCategory(entry)}
					data-lastgig={'lastGig' in entry.extra && entry.extra.lastGig}
					data-numbergigs={'gigCount' in entry.extra && entry.extra.gigCount}
					class={`filter-item ${MenuLi['vertical']} ${entry.entry.id === selected ? 'active' : ''}`}
				>
					<a
						class={MenuLinkWrapper['vertical']}
						style={{
							color: isDied(entry) ? 'rgb(150, 150, 150)' : ''
						}}
						data-markerkey={
							'lng' in entry.entry.data &&
							'lat' in entry.entry.data &&
							`LngLat(${entry.entry.data.lng}, ${entry.entry.data.lat})`
						}
						data-date={'date' in entry.entry.data ? entry.entry.data.date?.getTime() : undefined}
						href={selected ? entry.extra.absolutePath : undefined}
					>
						{entry.entry.data.title}
						{isAllAges(entry) && <AllAgesIndicator hideText={true} />}
						{'series' in entry.entry.data && <SeriesIndicator hideText={true} />}
						{'gigCount' in entry.extra && (
							<small
								title="Gig Count"
								style={{
									color: theme.color.dullText,
									width: '1.2em',
									display: 'inline-block',
									float: 'right',
									textAlign: 'right'
								}}
							>
								{entry.extra.gigCount}
							</small>
						)}
					</a>
				</li>
			))
	}
</ul>

<script>
	import { maintainSidebarScrollPosition } from 'src/util/helpers'
	const collection = window.location.pathname.split('/')[1]
	maintainSidebarScrollPosition(collection)
</script>
